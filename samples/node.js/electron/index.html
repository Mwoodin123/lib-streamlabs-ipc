<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
  </head>
  <body>
    
  </body>
  <script>	
	let count = 1000;
	let longMessage = "Varying Length is bad for testing, and ping pong tests are not good for our actual tests either.";

	const ipc_main = require('electron').remote.require("./streamlabs-ipc-node");
	const ipc_here = require('./streamlabs-ipc-node');

	var spn0 = document.createElement("div")
	var txt0 = document.createTextNode("Beginning tests");
	spn0.appendChild(txt0)
	document.body.appendChild(spn0)
	
	function test1() {
		console.log("Connecting and authenticating Main Process...");
		if (false == ipc_main.Connect("longSamplePathStreamlabs")) {
			console.log("Failed to connect main process.");
			return;
		}
		if (false == ipc_main.Authenticate()) {
			console.log("Failed to authenticate main process.");
			return;
		}
		
		console.log("Connecting and authenticating Renderer Process...");
		if (false == ipc_here.Connect("longSamplePathStreamlabs")) {
			console.log("Failed to connect renderer process.");
			return;
		}
		if (false == ipc_here.Authenticate()) {
			console.log("Failed to authenticate renderer process.");
			return;
		}
		
		let to = window.setTimeout(pongHere, 250);
	}
	
	function pongHere() {
		console.log("Testing v8 latency with native calls...");
		var t2 = 0;
		var t0 = performance.now();
		for (let n = 0; n < count; n++) {
			ipc_here.Pong(longMessage);
		}
		t2 += (performance.now() - t0);
		console.log("Total: " + t2 + " ms");
		console.log("Average: " + (t2 / count) + " ms.");
		let to = window.setTimeout(pongRemote, 250);
	}
	
	function pongRemote() {
		console.log("Testing electron.remote latency with native calls...");
		var t2 = 0;
		var t0 = performance.now()
		for (let n = 0; n < count; n++) {
			ipc_main.Pong(longMessage);
		}
		t2 += (performance.now() - t0);
		console.log("Total: " + t2 + " ms");
		console.log("Average: " + (t2 / count) + " ms.");
		let to = window.setTimeout(pingHere, 250);
	}
	
	function pingHere() {
		console.log("Testing ipc latency with native calls...");
		var t2 = 0;
		var t0 = performance.now();
		for (let n = 0; n < count; n++) {
			ipc_here.Ping(t0);
		}
		t2 += (performance.now() - t0);
		console.log("Total: " + t2 + " ms");
		console.log("Average: " + (t2 / count) + " ms.");
		let to = window.setTimeout(test4, 250);		
	}
	
	function test4() {
		console.log("Complete");
	}
	
	let to = window.setTimeout(test1, 250);	
	//ipc_main.Shutdown();
  </script>
</html>